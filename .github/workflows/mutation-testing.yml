name: Mutation Testing

on:
  pull_request:
    paths: ['**/*.py', '!**/tests/**']
  workflow_dispatch:
    inputs:
      mode:
        type: choice
        options: [full, changed-only]
        default: changed-only
        description: 'full: test all mutations, changed-only: test only changed files'

jobs:
  mutation:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for changed-only mode

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Cache mutation results
        uses: actions/cache@v4
        with:
          path: .mutmut-cache
          key: mutmut-${{ runner.os }}-${{ hashFiles('sequence_mcp/**/*.py') }}
          restore-keys: |
            mutmut-${{ runner.os }}-

      - name: Get changed files
        if: github.event_name == 'pull_request' && (github.event.inputs.mode != 'full')
        id: changed-files
        run: |
          # Get changed Python files excluding tests
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.py' \
            | grep -v tests/ \
            | grep -v conftest.py \
            | tr '\n' ' ' || true)
          echo "files=$CHANGED" >> $GITHUB_OUTPUT
          if [ -z "$CHANGED" ]; then
            echo "No Python source files changed"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Changed files: $CHANGED"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Run mutation testing (changed files only)
        if: |
          github.event_name == 'pull_request' &&
          (github.event.inputs.mode != 'full') &&
          steps.changed-files.outputs.skip != 'true'
        run: |
          # Run mutmut on changed files only (mutmut 3.x uses positional args)
          for file in ${{ steps.changed-files.outputs.files }}; do
            if [ -f "$file" ]; then
              echo "Testing mutations in: $file"
              mutmut run "$file" || true
            fi
          done
          mutmut results

      - name: Run mutation testing (full)
        if: |
          github.event_name == 'workflow_dispatch' &&
          github.event.inputs.mode == 'full'
        run: |
          mutmut run || true
          mutmut results

      - name: Skip message
        if: |
          github.event_name == 'pull_request' &&
          steps.changed-files.outputs.skip == 'true'
        run: echo "No Python source files changed - skipping mutation testing"

      - name: Generate mutation report
        if: always()
        run: |
          if [ -f .mutmut-cache ]; then
            echo "## Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            mutmut results >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No results available"
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
